<!doctype html>
<html lang="en">
<head>
		<meta charset="UTF-8">
		<meta name="viewport"
					content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>Climate By Station</title>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.5.1/plotly-basic.min.js" integrity="sha512-UKHNc6UAUh7ZjzSmyiNKZEdG9QICEZnjF+OEdqIGPi1NsKdhulHlsAcl2fu9+4ughCqpTMewKIIUuUvVsjdOvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

		<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

		<script src="./climate_by_station_widget.js"></script>

</head>
<body class="mt-3">

	<div class="container">
			<div class="row" style="min-height: 30rem;">
					<div class="col-12 col-md-4">
							<div class="mb-2">
									<div class="d-flex flex-column me-2">
											<label for="station">Station Id:</label>
											<input class="form-control" name="station" id="station" value="USC00094429">
									</div>

									<div>
											<button id="update" class="btn btn-primary">Update</button>
									</div>
							</div>
							<div class="mb-2">
									<label for="variables">Variables:</label>

									<select name="variables" id="variables" class="dropdown">
											<option class="dropdown-item" value="precipitation">Precipitation</option>
											<option class="dropdown-item" value="tmax">TMax</option>
											<option class="dropdown-item" value="tmin">TMin</option>
											<option class="dropdown-item" value="tavg">TAvg</option>
									</select>
							</div>
							<div class="mb-2">
									<label for="window">Window:</label>
									<input type="number" name="window" id="window" value="1">
							</div>
							<div class="mb-2">
									<label for="threshold">Threshold:</label>
									<input type="number" step="0.5" name="threshold" id="threshold" value="1">
							</div>
							<div class="mb-2">
									<label for="operators">Operators:</label>

									<select name="operators" id="operators">
											<option value=">=">at least (>=)</option>
											<option value="<=">not more than (<=)</option>
									</select>
							</div>
							<div class="mb-2">
									<label for="percentile">Percentiles:</label>

									<select name="percentile" id="percentile">
											<option value="80">80th</option>
											<option value="90">90th</option>
											<option value="95">95th</option>
									</select>
							</div>
					</div>
					<div class="col-12 col-md-8 d-flex">
							<div id="threshold-graph" class="flex-grow-1"></div>
					</div>
			</div>
			<div class="row">
					<div class="col-12 col-md-6" style="min-height: 20rem;">
							<div id="daily-absolute-precip-graph" class="flex-grow-1 h-100"></div>
					</div>
					<div class="align-items-center col-12 col-md-6" style="min-height: 20rem;">
							<div id="daily-absolute-temp-graph" class="flex-grow-1 h-100"></div>
					</div>
			</div>

			<div id="daily-absolute-minmax" class="flex-grow-1 h-100"></div>

	</div>

		<script type="module">

				let element = document.getElementById("threshold-graph");
				let daily_absolute_precip_element = document.getElementById("daily-absolute-precip-graph");
				let daily_absolute_temp_element = document.getElementById("daily-absolute-temp-graph");
				let daily_temp_minmax_element = document.getElementById("daily-absolute-minmax");

				const widget = new ClimateByStationWidget(element, {view_type: 'annual_exceedance'});
				const daily_absolute_precip_widget = new ClimateByStationWidget(daily_absolute_precip_element, {view_type: 'daily_precipitation_absolute'});
				const daily_absolute_temp_widget = new ClimateByStationWidget(daily_absolute_temp_element, {view_type: 'daily_temperature_absolute', variable: 'tmax', threshold: 95.0});
				const daily_temp_minmax_widget = new ClimateByStationWidget(daily_temp_minmax_element, {view_type: 'daily_temperature_minmax', variable: 'temp_min_max'});

				window.widget = widget;
				window.daily_absolute_precip_widget = daily_absolute_precip_widget;
				window.daily_absolute_temp_element = daily_absolute_temp_element;
				window.daily_temp_minmax_element = daily_temp_minmax_element;

				let stationElement = document.getElementById("station");
				let updateElement = document.getElementById("update");
				let windowElement = document.getElementById("window");
				let thresholdElement = document.getElementById("threshold");
				let variableElement = document.getElementById("variables");
				let operatorElement = document.getElementById("operators");
				let percentileElement = document.getElementById("percentile");

				windowElement.addEventListener('change', function(e) {
						let value = e.target.value;

						if(value < 1) {
								value = 1;
						}

						windowElement.value = value;
					  widget.update({window: Number.parseInt(value)})
				})

				thresholdElement.addEventListener('change', function(e) {
						let value = e.target.value;

						if(value < 0.0) {
								value = 0.0;
						}

						thresholdElement.value = value;
						widget.update({threshold: Number.parseFloat(value)})
						daily_absolute_precip_widget.update({threshold: Number.parseFloat(value)})
				})

				variableElement.addEventListener('change', function(e) {
						let value = e.target.value;
						let threshold;
						let window_behaviour;

						if(value === 'precipitation') {
								threshold = 1.0;
								window_behaviour = 'rollingSum';
								daily_absolute_precip_widget.update({variable: value, threshold: threshold});
						} else if(value === 'tmax') {
								threshold = 95.0;
								window_behaviour = 'all';
								daily_absolute_temp_widget.update({variable: value, threshold: threshold});
						} else if(value === 'tmin') {
								threshold = 32.0;
								window_behaviour = 'all';
								daily_absolute_temp_widget.update({variable: value, threshold: threshold});
						} else {
								threshold = 70.0;
								window_behaviour = 'all';
								daily_absolute_temp_widget.update({variable: value, threshold: threshold});
						}

						thresholdElement.value = threshold;
						widget.update({variable: value, threshold: threshold, window_behaviour: window_behaviour})
				})

				stationElement.addEventListener('change', function(e) {
						let value = e.target.value;
						stationElement.value = value;
				})

				updateElement.addEventListener('click', function(e) {
						e.preventDefault();

						let value = stationElement.value;
						widget.update({station: value});
				})

				operatorElement.addEventListener('change', function(e) {
						let value = e.target.value;

						widget.update({thresholdOperator: value});
				})

				percentileElement.addEventListener('change', function(e) {
						let value = e.target.value;

						let updatedThreshold = widget.view._get_percentile_value(Number.parseInt(value));

						if(widget.options.variable === 'precipitation') {
								daily_absolute_precip_widget.update({threshold: updatedThreshold});
						} else {
								daily_absolute_temp_widget.update({threshold: updatedThreshold});
						}

						thresholdElement.value = updatedThreshold;
						widget.update({threshold: updatedThreshold});
				})

		</script>
</body>
</html>
