<!doctype html>
<html lang="en">
<head>
		<meta charset="UTF-8">
		<meta name="viewport"
					content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>Climate By Station</title>

		<script src='https://cdn.plot.ly/plotly-2.4.2.min.js'></script>

		<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

		<script src="./climate_by_station_widget.js"></script>

		<link rel="stylesheet" href="style.css">
</head>
<body class="mt-3">

	<div class="container">
			<div class="row" style="min-height: 30rem;">
					<div class="col-12 col-md-4">
							<div class="d-flex mb-2">

									<div class="input-group me-2">
											<span class="input-group-text">Station ID</span>
											<input id="station" type="text" class="form-control">
									</div>

									<div>
											<button id="update" class="btn btn-primary">Update</button>
									</div>
							</div>
							<div class="mb-2">
									<div class="input-group">
											<label class="input-group-text" for="variables">Variables</label>
											<select class="form-select" id="variables">
													<option value="precipitation" selected>Precipitation</option>
													<option value="tmax">TMax</option>
													<option value="tmin">TMin</option>
													<option value="tavg">TAvg</option>
											</select>
									</div>
							</div>
							<div class="mb-2">
									<div class="input-group mb-3">
											<span class="input-group-text">Window</span>
											<input id="window" class="form-control" type="number" name="window" value="1">
											<span class="input-group-text">Days</span>
									</div>
							</div>
							<div class="mb-2">
									<div class="input-group mb-3">
											<span class="input-group-text">Threshold</span>
											<input id="threshold" class="form-control" type="number" step="0.5" name="threshold" value="1">
											<span class="input-group-text threshold-measurement">Inches</span>
									</div>
							</div>
							<div class="mb-2">
									<div class="input-group">
											<label class="input-group-text" for="operators">Operators</label>
											<select class="form-select" id="operators">
													<option value=">=">at least (>=)</option>
													<option value="<=">not more than (<=)</option>
											</select>
									</div>
							</div>
							<div class="mb-2">
									<div class="input-group">
											<label class="input-group-text" for="percentile">Percentiles</label>
											<select class="form-select" id="percentile">
													<option selected></option>
													<option value="80">80th</option>
													<option value="90">90th</option>
													<option value="95">95th</option>
											</select>
									</div>
							</div>
							<div class="mb-2">
									<div class="input-group">
											<label class="input-group-text" for="view-type">Views</label>
											<select class="form-select" id="view-type">
													<option value="annual_exceedance" selected>Annual Exceedance</option>
													<option value="daily_precipitation_absolute">Daily Precipitation Absolute</option>
													<option value="daily_temperature_absolute">Daily Temperature Absolute</option>
													<option value="daily_temperature_minmax">Daily Temperature Minimum and Maximum</option>
													<option value="daily_precipitation_normalized">Daily Precipitation Normalized</option>
													<option value="daily_temperature_normalized">Daily Temperature Normalized</option>
													<option value="daily_precipitation_histogram">Daily Precipitation Histogram</option>
													<option value="daily_temperature_histogram">Daily Temperature Histogram</option>
													<option value="daily_precipitation_ytd">Daily Precipitation Year to Date</option>
											</select>
									</div>
							</div>
							<div class="d-flex mb-2">
									<div class="me-2">
											<a class="btn btn-primary" id="download-data">Download Data</a>
									</div>
									<div>
											<a class="btn btn-secondary" id="download-image">Download Image</a>
									</div>
							</div>
					</div>
					<div class="col-12 col-md-8 d-flex">
							<div id="climate_by_station" class="flex-grow-1" style="position: relative;"></div>
					</div>
			</div>

			<!--Testing stuff below-->
			<div class="row">
					<div class="graph-container col-6">
							<div class="graph-wrapper">
									<div id="climate_by_station_1" class="graph-item"></div>
							</div>
					</div>
					<div class="graph-container col-6">
							<div class="graph-wrapper">
									<div id="climate_by_station_2" class="graph-item"></div>
							</div>
					</div>
			</div>


	</div>

		<script type="module">

				let element = document.getElementById("climate_by_station");

				const widget = new ClimateByStationWidget(element, {
						view_type: 'annual_exceedance'
				});

				const test1 = new ClimateByStationWidget(document.getElementById('climate_by_station_1'), {
						view_type: 'annual_exceedance'
				});

				const test2 = new ClimateByStationWidget(document.getElementById('climate_by_station_2'), {
						view_type: 'daily_temperature_minmax'
				});
				//
				// const test3 = new ClimateByStationWidget(document.getElementById('climate_by_station_3'), {
				// 		view_type: 'daily_precipitation_histogram'
				// });


				window.widget = widget;

				let stationElement = document.getElementById("station");
				let updateElement = document.getElementById("update");
				let windowElement = document.getElementById("window"); //works
				let thresholdElement = document.getElementById("threshold"); //works
				let variableElement = document.getElementById("variables"); //works
				let operatorElement = document.getElementById("operators");
				let percentileElement = document.getElementById("percentile");
				let viewTypeElement = document.getElementById("view-type");
				let measurementElement = document.querySelector('.threshold-measurement');

				stationElement.placeholder = widget.options.station;

				windowElement.addEventListener('change', function(e) {
						let value = e.target.value;

						if(value < 1) {
								value = 1;
						}

						windowElement.value = value;
					  widget.update({window: Number.parseInt(value)})
				})

				thresholdElement.addEventListener('change', function(e) {
						let value = e.target.value;

						if(value < 0.0) {
								value = 0.0;
						}

						thresholdElement.value = value;
						widget.update({threshold: Number.parseFloat(value)})
				})

				variableElement.addEventListener('change', function(e) {
						let value = e.target.value;

						widget.update({variable: value});

						thresholdElement.value = widget.options.threshold;
						windowElement.value = widget.options.window;
						measurementElement.innerText = widget.options.measurement;
						percentileElement.selectedIndex = 0;
				})

				stationElement.addEventListener('change', function(e) {
						let value = e.target.value;
						stationElement.value = value;
				})

				updateElement.addEventListener('click', function(e) {
						e.preventDefault();

						let value = stationElement.value;

						widget.update({station: value});

						stationElement.placeholder = widget.options.station;
				})

				operatorElement.addEventListener('change', function(e) {
						let value = e.target.value;
						widget.update({thresholdOperator: value});
				})

				percentileElement.addEventListener('change', function(e) {
						let value = e.target.value;

						if(typeof widget.view._get_percentile_value === 'function') {
								let updatedThreshold = widget.view._get_percentile_value(Number.parseInt(value));

								widget.update({threshold: updatedThreshold});
								thresholdElement.value = widget.options.threshold;
						}
				})

				viewTypeElement.addEventListener('change', function(e) {
						let value = e.target.value;

						widget.update({view_type: value});

						thresholdElement.value = widget.options.threshold;
						windowElement.value = widget.options.window;
						measurementElement.innerText = widget.options.measurement;
						percentileElement.selectedIndex = 0;
				})

				let downloadData = document.getElementById("download-data");

				downloadData.addEventListener('click', function(e) {
						if(!widget) return;

						e.preventDefault();

						if(widget.options.view_type === 'annual_exceedance') {
								widget.download_annual_exceedance();
						} else if(widget.options.view_type === 'daily_precipitation_absolute') {
								widget.download_daily_precipitation_absolute();
						} else if(widget.options.view_type === 'daily_temperature_absolute') {
								widget.download_daily_temperature_absolute();
						} else if(widget.options.view_type === 'daily_temperature_minmax') {
								widget.download_daily_temperature_minmax();
						} else if(widget.options.view_type === 'daily_temperature_normalized') {
								widget.download_daily_temperature_normalized();
						} else if(widget.options.view_type === 'daily_precipitation_normalized') {
								widget.download_daily_precipitation_normalized();
						}
				});

				let downloadImage = document.getElementById("download-image");

				downloadImage.addEventListener('click', function(e) {
						if(!widget) return;

						e.preventDefault();

						widget.download_image();
				});

		</script>
</body>
</html>
